<div id="main">
    <div class="breadcrumbs">
        <div class="col-sm-4">
            <div class="page-header float-left">
                <div class="page-title">
                    <h1>Dashboard</h1>
                </div>
            </div>
        </div>
        <div class="col-sm-8">
            <div class="page-header float-right">
                <div class="page-title">
                    <ol class="breadcrumb text-right">
                        <li><a href="/dashboard">Dashboard</a></li>
                        <li><a href="/gallery">Image</a></li>
                        <li><a href="javascript:void(0);">Upload</a></li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <form class="d-flex" id="add-image-form" enctype="multipart/form-data">
        <div class="mt-3 ml-1">
            <label class="form-label">Upload Image/Images</label><b>
                <input type="file" class="form-control " name="image" id="image" accept="image/*" multiple>
                <label id="image-error"></label>
                <br>
                <div id="upload-image-list" class="float-left row mt-2">
                </div>
        </div>
        <div class="ml-3 mt-5">
            <input type="submit" class="btn btn-primary submit-btn" value="Upload">
            <button type="button" class="btn btn-secondary cancel">Cancel</button>
        </div>

    </form>
    {{!--
    <script src="/javascripts/user/image.js"></script> --}}
</div>
<script>
    // const userObj = new settingsHandler();
    // userObj.init();
    $(function () {

        const uploadImage = {}
        $("#image").on('change', function () {
            const input = document.getElementById('image');
            const output = document.getElementById('upload-image-list');
            for (var i = 0; i < input.files.length; ++i) {
                uploadImage[input.files.item(i).name] = input.files.item(i);
                output.innerHTML += `<div class="col" data-image="${input.files.item(i).name}">
                    <a href="javascript:void(0);" class="fa fa-close float-right remove-image"></a>
                    <img class="image-upload text-danger ml-1" src=${window.URL.createObjectURL(input.files.item(i))} alt="Select Proper Image" />
                    </div>
                    `;
            }
        });

        $(document).on('click', '.remove-image', function () {
            const image = $(this).parent().attr('data-image');
            delete uploadImage[image];
            $("div").find(`[data-image='${image}']`).remove();
        });

        $(document).on('click', '.cancel', function () {
            window.location.href = 'http://localhost:3000/gallery';
        });

        /*
        $.validator.addMethod('filesize', function (value, element, param) {
            //add filesize rule to JqueryValidator which validates user to upload file greater than 2 mb size
            return this.optional(element) || (element.files[0].size <= param * 1000000)
        }, 'File size must be less than {2} MB');
        */

        $("#add-image-form").validate({

            //using jquery validations, validate user entered data to add a post
            keypress: true,
            rules: {
                "image": {
                    extension: "gif|jpeg|png|jpg",
                    // filesize: 2
                }
            },
            messages: {
                "image": {
                    extension: "Please select .gif , .png or .jpeg/.jpg file",
                    //filesize: "File must be less than 2 MB"
                }
            },
            //errorPlacement function to place error after element, if error generated
            errorPlacement: function (error, element) {
                if (element.attr('name') == "image") {
                    error.insertAfter("#image-error");
                } else {
                    error.insertAfter(element);
                }
            },
            submitHandler: function () {
                const formData = new FormData();
                for(let i = 0; i < Object.values(uploadImage).length; i++){
                    formData.append(`photos`, Object.values(uploadImage)[i]);
                }
                $.ajax({
                    //Ajax request of post method for add selected image in image collection
                    type: "post",
                    url: '/gallery/upload-image',
                    enctype: 'multipart/form-data',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (res) {
                        //success response of ajax call 
                        if (res.type == 'success') {
                            toastr.success("Image Added Successfully");
                        }
                        else {
                            alert("Image Added Fails");
                        }
                    },
                    error: function (err) {
                        // alert("Please Upload .gif,.jpeg or .png file");
                        console.log(err.toString());
                    }
                });
            }
        })
    });
</script>